/* eslint-disable simple-header/header */

import { ChatBarButton } from "@api/ChatButtons";
import { Margins } from "@utils/margins";
import { classes } from "@utils/misc";
import { openModal } from "@utils/modal";
import { Alerts, Forms } from "@webpack/common";

import { LLMModal } from "./ModelModal";
import { settings } from "./settings";
import { cl } from "./utils";

export function LLmIcon({ height = 20, width = 20, className }: { height?: number; width?: number; className?: string; }) {
    return (
        <svg
            viewBox="0 0 20 20"
            height={height}
            width={width}
            className={classes(cl("icon"), className)}
        >
            <path fill="currentColor" d="M9.62505 2.01477C8.25129 2.08214 6.87397 2.51392 5.72101 3.2387C4.98252 3.70298 4.11255 4.4958 3.64694 5.12892C2.1288 7.19329 1.63519 9.68209 2.27055 12.0687C2.53676 13.0687 3.01608 14.0647 3.61497 14.8624C4.79829 16.4386 6.6083 17.5273 8.62401 17.8753C11.304 18.338 14.049 17.4946 15.8742 15.6476C16.5001 15.0143 16.9359 14.3989 17.3329 13.5877C18.2549 11.704 18.4269 9.67645 17.8316 7.71049C17.271 5.85934 16.1407 4.3407 14.5635 3.31942C13.3707 2.54708 12.1085 2.12895 10.6595 2.02608C10.2123 1.99435 10.0729 1.99281 9.62505 2.01477ZM9.97254 2.92481C9.81895 2.97196 9.71324 3.06258 9.64337 3.2069C9.57783 3.34224 9.575 3.40534 9.575 4.72387V6.09962L9.46655 6.0829C9.40692 6.07373 9.17792 6.05708 8.95769 6.0459C8.34085 6.0146 7.10578 5.90479 7.10578 5.88123C7.10578 5.84352 7.29411 5.34551 7.40022 5.10273C7.65625 4.51672 8.1568 3.75967 8.67353 3.1769C8.91234 2.90756 8.90083 2.89177 8.52668 2.97499C7.60656 3.1797 6.80633 4.02798 6.25336 5.38478C6.17495 5.57718 6.10391 5.74152 6.09547 5.74993C6.08702 5.75837 5.7047 5.70124 5.24586 5.62296C4.54296 5.50307 4.40315 5.48766 4.35807 5.52506C4.29778 5.57511 3.92529 6.13099 3.94184 6.14624C3.97127 6.17333 5.76476 6.497 5.88545 6.497C5.89813 6.497 5.9014 6.50848 5.89272 6.52249C5.85822 6.57828 5.70433 7.37547 5.63993 7.83171C5.579 8.26359 5.47145 9.36266 5.47095 9.5585L5.47075 9.63357H4.13604H2.80133V10.0173V10.401H4.13174H5.46215L5.4851 10.7431C5.53782 11.5281 5.61717 12.1346 5.7756 12.9634C5.83273 13.2624 5.87097 13.5156 5.86052 13.526C5.85008 13.5365 5.54413 13.595 5.18065 13.6562C4.53112 13.7655 3.98238 13.8804 3.94865 13.9141C3.92983 13.9329 4.30301 14.4703 4.37485 14.5278C4.40759 14.5541 4.63079 14.5246 5.20381 14.4184C5.63509 14.3385 6.01255 14.2728 6.04261 14.2724C6.08018 14.2719 6.13137 14.3576 6.20665 14.547C6.59832 15.5326 7.1923 16.3656 7.76673 16.7349C7.88248 16.8093 8.0927 16.9079 8.23388 16.9539C8.49712 17.0397 8.87427 17.1012 8.87427 17.0582C8.87427 17.045 8.76703 16.9194 8.63596 16.7791C8.15306 16.2623 7.78808 15.7226 7.47042 15.0558C7.22407 14.5387 7.09073 14.1682 7.14008 14.1377C7.20545 14.0973 8.36965 13.995 9.19961 13.9569L9.575 13.9396V15.2964C9.575 16.6035 9.57753 16.6584 9.6446 16.7969C9.73062 16.9746 9.87177 17.0788 10.0535 17.0987C10.2342 17.1184 10.3981 17.0122 10.501 16.8087C10.5752 16.6618 10.576 16.6442 10.576 15.298V13.9359L10.9347 13.9555C11.8355 14.0046 12.996 14.1112 13.033 14.1482C13.0407 14.1559 13.0029 14.2807 12.949 14.4255C12.6109 15.3342 12.2553 15.937 11.6246 16.671L11.269 17.0849L11.4676 17.0642C11.7386 17.0358 12.153 16.8835 12.3946 16.7234C12.9528 16.3535 13.5756 15.4919 13.9015 14.6387C13.9681 14.4644 14.0331 14.3098 14.0459 14.2953C14.0679 14.2703 15.0107 14.416 15.5194 14.523C15.6484 14.5501 15.767 14.5642 15.7829 14.5544C15.8474 14.5145 16.2169 13.9265 16.192 13.9035C16.1542 13.8686 15.605 13.7563 14.8807 13.6355C14.5413 13.5789 14.2607 13.5295 14.257 13.5259C14.2534 13.5222 14.2791 13.392 14.3143 13.2365C14.4809 12.4988 14.6469 11.2167 14.6469 10.6679V10.445L15.4031 10.4231C15.8189 10.4109 16.4346 10.401 16.7712 10.401H17.3831V10.0534C17.3831 9.86221 17.374 9.68202 17.3628 9.65299C17.3448 9.60608 17.1934 9.60021 15.9998 9.60021H14.6571L14.6352 9.19002C14.5922 8.38705 14.4123 7.13276 14.2601 6.57558C14.242 6.50935 14.2587 6.50124 14.4854 6.46627C15.4458 6.31815 16.1704 6.17547 16.1992 6.12875C16.2235 6.08951 15.8625 5.53274 15.7963 5.50734C15.7558 5.49179 14.633 5.65616 14.1441 5.74923C14.0624 5.76481 14.0495 5.74472 13.8659 5.31538C13.239 3.84983 12.4335 3.07052 11.4122 2.94156L11.2307 2.91863L11.4568 3.16456C11.7234 3.45452 12.1838 4.06152 12.3519 4.34478C12.5309 4.64649 12.7297 5.05574 12.874 5.41989C13.0791 5.93739 13.0968 5.87929 12.7204 5.92521C12.2669 5.9805 11.7187 6.02268 11.1016 6.04977L10.576 6.07283V4.73828C10.576 3.81329 10.5642 3.36893 10.5373 3.29032C10.4405 3.00656 10.2042 2.85367 9.97254 2.92481ZM6.87484 6.75543C6.66415 7.54595 6.51887 8.52506 6.49732 9.2999L6.48847 9.61689L8.03173 9.62557L9.575 9.63424V8.23576V6.83725L9.18292 6.81586C8.1562 6.75987 7.47102 6.70602 7.03203 6.64679C6.91251 6.63067 6.90707 6.63444 6.87484 6.75543ZM12.795 6.68243C12.5931 6.70612 12.1201 6.74159 11.7439 6.76134C11.3677 6.78106 10.951 6.80602 10.8179 6.8168L10.576 6.83638V8.21828V9.60021H12.1238H13.6716L13.6574 9.37497C13.5776 8.10483 13.3209 6.61052 13.1866 6.63494C13.1731 6.63741 12.9969 6.65877 12.795 6.68243ZM6.47209 10.5428C6.47299 10.9903 6.58971 11.9232 6.7416 12.6969C6.88275 13.4159 6.8655 13.3839 7.0982 13.3579C7.75955 13.2839 8.39134 13.2332 8.8409 13.218C9.12536 13.2083 9.40692 13.1931 9.46655 13.184L9.575 13.1675V11.7843V10.401H8.02339H6.47179L6.47209 10.5428ZM10.576 11.7831V13.1653L10.7846 13.1834C10.8993 13.1934 11.1883 13.2103 11.4269 13.2211C11.6655 13.2319 12.1535 13.2698 12.5114 13.3055C12.8692 13.3412 13.1862 13.3704 13.2157 13.3706C13.331 13.371 13.6459 11.3971 13.6459 10.6737V10.444L13.4206 10.4228C13.2968 10.4111 12.606 10.4014 11.8857 10.4013L10.576 10.401V11.7831Z" />
        </svg>
    );
}

export const LLmChatBarIcon: ChatBarButton = ({ isMainChat }) => {
    const { autoRewrite, showChatBarButton } = settings.use(["autoRewrite", "showChatBarButton"]);

    if (!isMainChat || !showChatBarButton) return null;

    const toggle = () => {
        const newState = !autoRewrite;
        settings.store.autoRewrite = newState;
        if (newState && settings.store.showAutoRespondAlert !== false)
            Alerts.show({
                title: "Vencord AI Rewriting Enabled",
                body: <>
                    <Forms.FormText>
                        You just enabled auto rewriting (by right clicking the LLM icon). Any message you send will automatically be rewritten by the LLM.
                    </Forms.FormText>
                    <Forms.FormText className={Margins.top16}>
                        If you don't want this, you can disable it by clicking the LLM icon again.
                    </Forms.FormText>
                </>,
                cancelText: "Disable Auto-Rewriting",
                confirmText: "Got it",
                secondaryConfirmText: "Don't show again",
                onConfirmSecondary: () => settings.store.showAutoRespondAlert = false,
                onCancel: () => settings.store.autoRewrite = false
            });
    };

    return (
        <ChatBarButton
            tooltip="Automatic LLM Rewriting"
            onClick={e => {
                if (e.shiftKey) return toggle();

                openModal(props => (
                    <LLMModal rootProps={props} />
                ));
            }}
            onContextMenu={() => toggle()}
            buttonProps={{
                "aria-haspopup": "dialog"
            }}
        >
            <LLmIcon className={cl({ "progress": autoRewrite, "chat-button": true })} />
        </ChatBarButton>
    );
};
